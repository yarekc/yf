console.log("");class Yf{constructor(){this.data={},this.states={},this.currentStates={},this.bindings=new Map,this.components=new Map,this.initialized=!1,this.ready=!1,this.pendingOperations=[],this.observer=null}init(){"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>this.setup()):this.setup()}setup(){this.initialized||(this.initialized=!0,this.storeOriginalAttributes(),this.loadComponents(),this.setupDataBinding(),this.setupRouting(),this.parseDOM(),this.restoreStateFromURL(),document.body.removeAttribute("data-cloak"),this.ready=!0,this.pendingOperations.forEach(t=>t()),this.pendingOperations=[],requestAnimationFrame(()=>{this.bindings.forEach((t,e)=>{this.updateBindings(e)})}))}storeOriginalAttributes(){document.querySelectorAll("*").forEach(t=>{t._originalAttributes={},Array.from(t.attributes).forEach(e=>{t._originalAttributes[e.name]=e.value})})}getNestedValue(t,e){if(!e.includes("."))return t[e];const i=e.split(".");let s=t;for(let t of i){if(!s||"object"!=typeof s||!(t in s))return;s=s[t]}return s}setNestedValue(t,e,i){if(!e.includes("."))return void(t[e]=i);const s=e.split("."),n=s.pop();let o=t;for(let t of s)t in o&&"object"==typeof o[t]||(o[t]={}),o=o[t];o[n]=i}set(t,e){if(!this.ready)return void this.pendingOperations.push(()=>this.set(t,e));const i=this.getNestedValue(this.data,t);if(i!==e||Array.isArray(e)||e&&"object"==typeof e&&!Array.isArray(e)){if(this.setNestedValue(this.data,t,e),this.updateBindings(t),t.includes(".")){const e=t.split(".");for(let t=e.length-1;t>0;t--){const i=e.slice(0,t).join(".");this.updateBindings(i)}}window.dispatchEvent(new CustomEvent("yf-data-changed",{detail:{key:t,value:e,oldValue:i}}))}}get(t){return this.getNestedValue(this.data,t)}setupDataBinding(){this.scanBindings(),this.observer=new MutationObserver(t=>{this.observer.disconnect(),this.scanBindings(),this.observer.observe(document.body,{childList:!0,subtree:!0})}),this.observer.observe(document.body,{childList:!0,subtree:!0})}scanBindings(){document.querySelectorAll("[data-bind]").forEach(t=>{const e=t.getAttribute("data-bind");this.bindings.has(e)||this.bindings.set(e,new Set);let i=!1;if(this.bindings.get(e).forEach(e=>{e===t&&(i=!0)}),i||this.bindings.get(e).add(t),"INPUT"===t.tagName||"TEXTAREA"===t.tagName||"SELECT"===t.tagName){if(!t._bindingHandler){t._bindingHandler=t=>{"checkbox"===t.target.type?this.set(e,t.target.checked):this.set(e,t.target.value)};const i="checkbox"===t.type?"change":"input";t.addEventListener(i,t._bindingHandler)}const i=this.getNestedValue(this.data,e);void 0!==i?"checkbox"===t.type?t.checked=!!i:t.value=i:"checkbox"===t.type?this.set(e,t.checked):t.value&&this.set(e,t.value)}}),this.scanTemplateBindings(),this.scanAttributeBindings(),this.processShowDirectives(),this.processIterators()}scanTemplateBindings(){const t=document.createTreeWalker(document.body,NodeFilter.SHOW_TEXT,null,!1),e=[];let i;for(;i=t.nextNode();)i.nodeValue.includes("{")&&i.nodeValue.includes("}")&&e.push(i);e.forEach(t=>{const e=t.nodeValue,i=e.match(/\{([^}]+)\}/g);i&&i.forEach(i=>{const s=i.slice(1,-1).trim().match(/^([\w]+)/);if(s){const i=s[1];this.bindings.has(i)||this.bindings.set(i,new Set),t._originalTemplate||(t._originalTemplate=e);let n=!1;this.bindings.get(i).forEach(e=>{e===t&&(n=!0)}),n||this.bindings.get(i).add(t)}})})}scanAttributeBindings(){document.querySelectorAll("*").forEach(t=>{this.components.has(t.tagName.toLowerCase())||Array.from(t.attributes).forEach(e=>{const i=e.value;if(i.includes("{")&&i.includes("}")){const s=i.match(/\{([\w.]+)\}/g);s&&s.forEach(s=>{const n=s.slice(1,-1);this.bindings.has(n)||this.bindings.set(n,new Set),t._attributeTemplates||(t._attributeTemplates={}),t._attributeTemplates[e.name]||(t._attributeTemplates[e.name]=i);const o={element:t,attribute:e.name,isAttribute:!0};let a=!1;this.bindings.get(n).forEach(i=>{i.isAttribute&&i.element===t&&i.attribute===e.name&&(a=!0)}),a||this.bindings.get(n).add(o)})}})})}processShowDirectives(){document.querySelectorAll("[show]").forEach(t=>{let e=t._originalAttributes&&t._originalAttributes.show?t._originalAttributes.show:t.getAttribute("show");console.log("Original condition:",e);const i=e.match(/^\{(.+)\}$/);i&&(e=i[1],console.log("Extracted condition:",e)),t._originalDisplay||(t._originalDisplay=t.style.display||""),this.bindings.has(e)||this.bindings.set(e,new Set);const s={element:t,isShow:!0,condition:e};let n=!1;this.bindings.get(e).forEach(e=>{e.isShow&&e.element===t&&(n=!0)}),n||this.bindings.get(e).add(s),this.evaluateShow(t,e)})}evaluateShow(t,e){let i;console.log("Evaluating show condition:",e),e.match(/[=!<>]/)?(console.log("Is expression"),i=this.evaluateExpression(e)):(console.log("Is simple key"),i=this.getNestedValue(this.data,e)),console.log("Evaluated value:",i),t._originalDisplay||(t._originalDisplay=t.style.display||""),t.style.display=i?"none"===t._originalDisplay?"":t._originalDisplay:"none"}evaluateBinding(t){if(/^[\w.]+$/.test(t)){const e=this.getNestedValue(this.data,t);return void 0!==e&&"object"==typeof e?JSON.stringify(e):e}if(t.includes(":")&&!t.includes("?"))return t;try{const e=new Function("data",`with(data) { try { return ${t}; } catch(e) { return undefined; } }`)(this.data);return void 0!==e&&"object"==typeof e?JSON.stringify(e):e}catch(e){return console.warn(`Failed to evaluate binding expression: ${t}`,e),t}}evaluateExpression(t){console.log("Evaluating expression:",t),console.log("Current data:",this.data);let e=t;(t.match(/[\w.]+/g)||[]).forEach(t=>{if(["true","false","null","undefined"].includes(t))return;const i=this.getNestedValue(this.data,t);if(void 0!==i){const s="string"==typeof i?`"${i}"`:i;e=e.replace(new RegExp(`\\b${t}\\b`,"g"),s)}else e=e.replace(new RegExp(`\\b${t}\\b`,"g"),"0")});try{const t=new Function("return "+e)();return console.log("Expression result:",t),t}catch(e){return console.warn(`Failed to evaluate expression: ${t}`,e),!1}}updateBindings(t){const e=this.bindings.get(t);e&&e.forEach(e=>{if(e.isIterator)this.renderIterator(e.element);else if(e.isShow)this.evaluateShow(e.element,e.condition);else if(e.isAttribute){const t=e.element,i=e.attribute,s=t._attributeTemplates[i].replace(/\{([\w.]+)\}/g,(t,e)=>{const i=this.getNestedValue(this.data,e);return void 0!==i?i:""});t.setAttribute(i,s)}else if(e.nodeType===Node.TEXT_NODE){const t=e._originalTemplate||e.nodeValue;e.nodeValue=t.replace(/\{([^}]+)\}/g,(t,e)=>{e=e.trim();const i=this.evaluateBinding(e);return void 0!==i?i:t})}else if("INPUT"===e.tagName||"TEXTAREA"===e.tagName||"SELECT"===e.tagName){const i=this.getNestedValue(this.data,t);"checkbox"===e.type?e.checked=!!i:"radio"===e.type||e.value!==i&&(e.value=i||"")}else{const i=this.getNestedValue(this.data,t);e.textContent=i||""}})}setupRouting(){this.parseStates(),window.addEventListener("hashchange",()=>{this.restoreStateFromURL()})}parseStates(){document.querySelectorAll("[id]").forEach(t=>{const e=Array.from(t.children).filter(t=>t.hasAttribute("state"));if(e.length>0){const i=t.id;this.states[i]||(this.states[i]={}),e.forEach(t=>{const e=t.getAttribute("state");this.states[i][e]=t,t.style.display="none"})}})}parseDOM(){document.querySelectorAll("[id]").forEach(t=>{const e=Array.from(t.children).filter(t=>t.hasAttribute("state"));if(e.length>0&&!this.currentStates[t.id]){const i=e[0].getAttribute("state");this.currentStates[t.id]=i,e[0].style.display=""}})}setState(t,e){this.states[t]?this.states[t][e]?(Object.values(this.states[t]).forEach(t=>{t.style.display="none"}),this.states[t][e].style.display="",this.currentStates[t]=e,this.updateURL()):console.warn(`State "${e}" not found in container "${t}"`):console.warn(`Container "${t}" not found`)}updateURL(){const t=Object.entries(this.currentStates).map(([t,e])=>`${t}:${e}`).join(",");window.location.hash=t}restoreStateFromURL(){const t=window.location.hash.slice(1);if(!t)return;t.split(",").forEach(t=>{const[e,i]=t.split(":");e&&i&&this.states[e]&&this.states[e][i]&&(Object.values(this.states[e]).forEach(t=>{t.style.display="none"}),this.states[e][i].style.display="",this.currentStates[e]=i)})}getState(t){return this.currentStates[t]}registerComponent(t,e){this.components.set(t,e)}loadComponents(){document.querySelectorAll("template[component]").forEach(t=>{const e=t.getAttribute("component"),i=t.innerHTML;this.registerComponent(e,i)}),this.components.forEach((t,e)=>{document.querySelectorAll(e).forEach(t=>{t._originalAttributes||(t._originalAttributes={},Array.from(t.attributes).forEach(e=>{t._originalAttributes[e.name]=e.value}))})}),this.processComponents()}processIterators(){document.querySelectorAll("[data-for]").forEach(t=>{const e=t.getAttribute("data-for"),i=e.match(/([\w.]+)\s+(?:in|as)\s+([\w.]+)/);if(!i)return void console.warn(`Invalid data-for syntax: "${e}"`);const s=i[2],n=i[1];t._iteratorTemplate||(t._iteratorTemplate=t.innerHTML,t._iteratorItemName=s,t._iteratorArrayKey=n),this.bindings.has(n)||this.bindings.set(n,new Set);const o={element:t,isIterator:!0,arrayKey:n,itemName:s};let a=!1;this.bindings.get(n).forEach(e=>{e.isIterator&&e.element===t&&(a=!0)}),a||this.bindings.get(n).add(o),this.renderIterator(t)})}renderIterator(t){const e=t._iteratorTemplate,i=t._iteratorItemName,s=t._iteratorArrayKey,n=this.getNestedValue(this.data,s);if(!Array.isArray(n))return void(t.innerHTML="");let o="";n.forEach((t,s)=>{let n=e;n=n.replace(new RegExp(`\\{(${i}[^}]*)\\}`,"g"),(e,s)=>{s=s.trim();try{const e=s.replace(new RegExp(`^${i}\\.?`),"item."),n=new Function("item",`return ${e};`)(t);return!0===n?"checked":!1===n?"":void 0!==n?n:""}catch(t){return console.warn(`Failed to evaluate expression: ${s}`,t),""}}),o+=n}),this.observer&&this.observer.disconnect(),t.innerHTML=o,this.observer&&this.observer.observe(document.body,{childList:!0,subtree:!0})}processComponents(){document.querySelectorAll("[component]:not(template)").forEach(t=>{const e=t.getAttribute("component"),i=this.components.get(e);if(!i)return void console.warn(`Component "${e}" not found`);const s={};Array.from(t.attributes).forEach(t=>{"component"!==t.name&&(s[t.name]=t.value)});const n=this.renderComponent(i,s);t.innerHTML=n,t.removeAttribute("component")}),this.components.forEach((t,e)=>{document.querySelectorAll(e).forEach(e=>{const i={};Array.from(e.attributes).forEach(t=>{i[t.name]=t.value});const s=this.renderComponent(t,i),n=document.createElement("div");n.innerHTML=s,e.replaceWith(...n.childNodes)})})}renderComponent(t,e){let i=t;return i=i.replace(/\{prop:([\w.]+)\}/g,(t,i)=>e[i]||""),i=i.replace(/\{([\w.]+)\}/g,(t,i)=>{const s=e["data-"+i];if(void 0!==s)return"{"+s+"}";const n=e[i];return void 0===n?t:("string"==typeof n&&n.includes("{")&&n.includes("}"),n)}),i}async loadComponentFromFile(t,e){try{const i=await fetch(e),s=await i.text();this.registerComponent(t,s);const n=document.querySelectorAll(t);this.observer&&this.observer.disconnect(),n.forEach(t=>{const e={};t._originalAttributes?Object.assign(e,t._originalAttributes):Array.from(t.attributes).forEach(t=>{e[t.name]=t.value});const i=this.renderComponent(s,e),n=document.createElement("div");n.innerHTML=i,t.replaceWith(...n.childNodes)}),this.bindings.forEach((t,e)=>{t.forEach(e=>{e.nodeType===Node.TEXT_NODE?e.parentNode&&document.body.contains(e.parentNode)||t.delete(e):e.element?document.body.contains(e.element)||t.delete(e):document.body.contains(e)||t.delete(e)})}),this.scanBindings(),this.bindings.forEach((t,e)=>{this.updateBindings(e)}),this.observer&&this.observer.observe(document.body,{childList:!0,subtree:!0})}catch(i){console.error(`Failed to load component "${t}" from ${e}:`,i)}}}const app=new Yf;if(app.init(),window.setState=(t,e)=>app.setState(t,e),window.getState=t=>app.getState(t),window.setData=(t,e)=>app.set(t,e),window.getData=t=>app.get(t),window.registerComponent=(t,e)=>app.registerComponent(t,e),window.loadComponent=(t,e)=>app.loadComponentFromFile(t,e),window.renderComponents=()=>app.processComponents(),document.head){const t=document.createElement("style");t.textContent="[data-cloak] { visibility: hidden; }",document.head.appendChild(t)}